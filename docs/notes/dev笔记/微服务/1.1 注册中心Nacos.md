## Nacosç®€ä»‹

- `Nacos`æ˜¯ç”±é˜¿é‡Œå·´å·´å›¢é˜Ÿä½¿ç”¨ Java è¯­è¨€å¼€å‘çš„å¼€æºé¡¹ç›®ã€‚

- ä¸€ä¸ªæ›´æ˜“äºæ„å»ºäº‘åŸç”Ÿåº”ç”¨çš„åŠ¨æ€æœåŠ¡å‘ç°ã€é…ç½®ç®¡ç†å’ŒæœåŠ¡ç®¡ç†å¹³å°ã€‚`Nacos`æ˜¯`Dynamic Naming and Configuration Service`çš„é¦–å­—æ¯ç®€ç§°ã€‚

- `Nacos`å°±æ˜¯æ³¨å†Œä¸­å¿ƒ+é…ç½®ä¸­å¿ƒçš„ç»„åˆï¼ˆ`Nacos` = `Eureka` + `Config` + `Bus`ï¼‰ã€‚


## Nacoså®‰è£…

- ä¸‹è½½`Nacos`å®‰è£…åŒ… [Nacoså®˜ç½‘](https://nacos.io/)

- æ”¯æŒå¤šç§å®‰è£…æ–¹å¼ï¼ˆå‹ç¼©åŒ…è§£å‹å³ç”¨ã€`docker`é•œåƒè¿è¡Œã€`k8s`éƒ¨ç½²ï¼‰

- binç›®å½•ä¸‹æœ‰`startup.cmd`å’Œ`startup.sh`ä¸¤ä¸ªå¯åŠ¨è„šæœ¬ï¼Œåˆ†åˆ«é€‚ç”¨äºWindowså’ŒLinuxç³»ç»Ÿã€‚

- å¯åŠ¨åé»˜è®¤åœ°å€æ˜¯`http://localhost:8848/nacos`ï¼Œé»˜è®¤ç”¨æˆ·åå¯†ç éƒ½æ˜¯`nacos`ã€‚


## Nacosé›†ç¾¤æ­å»º

æ­å»ºä¸€ä¸ªç”Ÿäº§å¯ç”¨çš„Nacosé›†ç¾¤ï¼Œä¸»è¦åŒ…å«ä»¥ä¸‹å‡ ä¸ªæ ¸å¿ƒæ­¥éª¤ï¼š

- ç¯å¢ƒå‡†å¤‡ï¼šè‡³å°‘å‡†å¤‡3ä¸ªæˆ–ä»¥ä¸Šçš„å¥‡æ•°ä¸ªèŠ‚ç‚¹ã€‚è¿™æ˜¯ç”±åº•å±‚çš„ä¸€è‡´æ€§ç®—æ³•ï¼ˆRaftåè®®ï¼‰æ‰€å†³å®šçš„ï¼Œå¥‡æ•°ä¸ªèŠ‚ç‚¹èƒ½æœ‰æ•ˆé¿å…é€‰ä¸¾æ—¶å‡ºç°å¹³ç¥¨åƒµå±€ã€‚

- é…ç½®æ•°æ®åº“ï¼šNacosé›†ç¾¤éœ€è¦å°†å…ƒæ•°æ®ï¼ˆå¦‚é…ç½®ä¿¡æ¯ã€ç”¨æˆ·æƒé™ï¼‰æŒä¹…åŒ–åˆ°å¤–éƒ¨çš„å…±äº«æ•°æ®åº“ï¼ˆå¦‚MySQLï¼‰ã€‚ä½ éœ€è¦åˆ›å»ºä¸€ä¸ªæ•°æ®åº“ï¼Œå¹¶æ‰§è¡ŒNacosæä¾›çš„SQLè„šæœ¬æ¥åˆå§‹åŒ–è¡¨ç»“æ„ã€‚

- ä¿®æ”¹èŠ‚ç‚¹é…ç½®ï¼šåœ¨æ¯ä¸ªNacosèŠ‚ç‚¹çš„ application.properties æ–‡ä»¶ä¸­é…ç½®ä¸Šä¸€æ­¥éª¤çš„æ•°æ®åº“è¿æ¥ä¿¡æ¯ã€‚åŒæ—¶ï¼Œåœ¨ cluster.conf æ–‡ä»¶ä¸­åˆ—å‡ºé›†ç¾¤å†…æ‰€æœ‰èŠ‚ç‚¹çš„IPåœ°å€å’Œç«¯å£ï¼ˆé»˜è®¤ä¸º8848ï¼‰ã€‚

- å¯åŠ¨ä¸æ¥å…¥ï¼šé€å°æˆ–åŒæ—¶å¯åŠ¨æ‰€æœ‰NacosèŠ‚ç‚¹ã€‚å¾®æœåŠ¡åº”ç”¨åœ¨é…ç½®æ³¨å†Œä¸­å¿ƒåœ°å€æ—¶ï¼Œå¯ä»¥ä½¿ç”¨è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¦‚Nginxï¼‰ä½œä¸ºç»Ÿä¸€çš„æ¥å…¥ç‚¹ã€‚


## é›†ç¾¤æ ¸å¿ƒå·¥ä½œåŸç†

Nacosé›†ç¾¤çš„è®¾è®¡å·§å¦™ä¹‹å¤„åœ¨äºå…¶æ— ä¸­å¿ƒåŒ–å’Œæ•°æ®ä¸€è‡´æ€§çš„ä¿éšœã€‚

- æ— ä¸­å¿ƒåŒ–ä¸VIPï¼šåœ¨ç”Ÿäº§ç¯å¢ƒä¸­ï¼Œé€šå¸¸ä¸ä¼šè®©å¾®æœåŠ¡ç›´æ¥è¿æ¥æŸä¸ªç‰¹å®šçš„NacosèŠ‚ç‚¹ã€‚ç›¸åï¼Œä¼šä½¿ç”¨ä¸€ä¸ªè™šæ‹ŸIPï¼ˆVIPï¼‰ æˆ–è´Ÿè½½å‡è¡¡å™¨ï¼ˆå¦‚Nginxï¼‰ä½œä¸ºç»Ÿä¸€çš„æ¥å…¥ç‚¹ï¼Œä»è€Œå±è”½åç«¯èŠ‚ç‚¹çš„ç‰©ç†IPï¼Œå®ç°å®¢æˆ·ç«¯ä¸é›†ç¾¤ç»†èŠ‚çš„è§£è€¦ã€‚

- æ•°æ®ä¸€è‡´æ€§åè®®ï¼ˆRaftï¼‰ï¼šNacosé›†ç¾¤é‡‡ç”¨ Raftä¸€è‡´æ€§ç®—æ³• æ¥ä¿è¯æ‰€æœ‰èŠ‚ç‚¹é—´æ•°æ®çš„å¼ºä¸€è‡´æ€§ã€‚è¯¥ç®—æ³•é€šè¿‡é€‰ä¸¾æœºåˆ¶äº§ç”Ÿä¸€ä¸ª Leader èŠ‚ç‚¹ï¼Œè´Ÿè´£æ¥æ”¶æ‰€æœ‰å®¢æˆ·ç«¯çš„å†™è¯·æ±‚ï¼ˆå¦‚æœåŠ¡æ³¨å†Œã€é…ç½®å‘å¸ƒï¼‰ã€‚éšåï¼ŒLeaderå°†æ•°æ®å˜æ›´åŒæ­¥ç»™å…¶ä»–çš„ Follower èŠ‚ç‚¹ï¼Œåªæœ‰å¤§å¤šæ•°èŠ‚ç‚¹ï¼ˆè¿‡åŠï¼‰ç¡®è®¤æˆåŠŸåï¼Œè¿™æ¬¡å†™æ“ä½œæ‰ä¼šè¢«ç¡®è®¤ã€‚è¿™æ ·å¯ä»¥ç¡®ä¿å³ä½¿å•ä¸ªèŠ‚ç‚¹æ•…éšœï¼Œæ•°æ®ä¹Ÿä¸ä¼šä¸¢å¤±ã€‚

- é…ç½®åŒæ­¥æœºåˆ¶ï¼šå¯¹äºé…ç½®ä¸­å¿ƒçš„æ•°æ®ï¼Œå˜æ›´æ—¶ä¼šå…ˆå†™å…¥å…±äº«æ•°æ®åº“ï¼Œç„¶åç”±LeaderèŠ‚ç‚¹é€šçŸ¥å…¶ä»–èŠ‚ç‚¹ä»æ•°æ®åº“ dump æœ€æ–°æ•°æ®åˆ°æœ¬åœ°æ–‡ä»¶ç¼“å­˜ï¼Œä»¥æé«˜è¯»å–æ€§èƒ½ã€‚

- èŠ‚ç‚¹é—´çš„å¿ƒè·³ç›‘æµ‹ï¼šå®ƒä»¬ä¹‹é—´çš„å¥åº·æ„ŸçŸ¥å’Œæ•°æ®ä¸€è‡´æ€§æ˜¯é€šè¿‡æ›´åº•å±‚çš„ Raftåè®®çš„å¿ƒè·³æœºåˆ¶ æ¥å®ç°çš„ã€‚LeaderèŠ‚ç‚¹ä¼šå®šæœŸå‘æ‰€æœ‰FollowerèŠ‚ç‚¹å‘é€å¿ƒè·³æ¶ˆæ¯ï¼ˆä¸€ç§ä¸åŒ…å«æ•°æ®å†…å®¹çš„ç‰¹æ®ŠAppendEntries RPCï¼‰è¿™ä¸»è¦æœ‰ä¸¤ä¸ªç›®çš„ï¼š1ã€ç»´æŒé¢†å¯¼æƒï¼šå‘ŠçŸ¥Followerè‡ªå·±ä»ç„¶å­˜æ´»ï¼Œé˜²æ­¢è§¦å‘æ–°çš„é€‰ä¸¾ã€‚2ã€æºå¸¦æ—¥å¿—åŒæ­¥ä¿¡æ¯ï¼šåœ¨å¤§å¤šæ•°æƒ…å†µä¸‹ï¼Œå¿ƒè·³ä¼šé™„å¸¦æ—¥å¿—ä¿¡æ¯ï¼Œç”¨äºæ•°æ®åŒæ­¥ã€‚å¦‚æœä¸€ä¸ªFollowerèŠ‚ç‚¹åœ¨è¶…è¿‡é€‰ä¸¾è¶…æ—¶æ—¶é—´ï¼ˆElection Timeoutï¼‰åä»æœªæ”¶åˆ°Leaderçš„å¿ƒè·³ï¼Œå®ƒå°±ä¼šè®¤ä¸ºLeaderå·²ç»å®•æœºï¼Œå¹¶ä¸»åŠ¨å‘èµ·é€‰ä¸¾ï¼Œå°è¯•ä½¿è‡ªå·±æˆä¸ºæ–°çš„Leaderï¼Œä»¥ç»´æŒé›†ç¾¤çš„å¯ç”¨æ€§ã€‚


## é›†ç¾¤æ— ä¸­å¿ƒåŒ–çš„å‘

- ç”±äºæ— ä¸­å¿ƒåŒ–ï¼Œå¾®æœåŠ¡æ˜¯é…ç½®çš„Nginxä½œä¸ºç»Ÿä¸€çš„æ¥å…¥ç‚¹ã€‚Nginxä½œä¸ºè´Ÿè½½å‡è¡¡å™¨é»˜è®¤æ˜¯æ— çŠ¶æ€çš„è½®è¯¢ï¼Œå®ƒæœ¬èº«æ— æ³•åŒºåˆ†å“ªä¸ªNacosèŠ‚ç‚¹æ˜¯Leaderã€‚

- Nacosé›†ç¾¤èŠ‚ç‚¹è‡ªèº«å†…ç½®äº†ä¸€å¥—å¼ºå¤§çš„â€œè¯·æ±‚è½¬å‘â€æœºåˆ¶ã€‚Nacosé›†ç¾¤çš„æ¯ä¸ªèŠ‚ç‚¹éƒ½éå¸¸æ¸…æ¥šè‡ªå·±åœ¨Raftç»„ä¸­çš„è§’è‰²ï¼ˆLeaderæˆ–Followerï¼‰ã€‚å½“å®¢æˆ·ç«¯çš„ä¸€ä¸ªå†™è¯·æ±‚ï¼ˆä¾‹å¦‚ï¼ŒæœåŠ¡æ³¨å†Œã€é…ç½®å‘å¸ƒï¼‰é€šè¿‡Nginxè¢«éšæœºåˆ†é…åˆ°ä¸€ä¸ªFollowerèŠ‚ç‚¹æ—¶ï¼ŒFollowerèŠ‚ç‚¹ä¸ä¼šå¤„ç†è¿™ä¸ªè¯·æ±‚ï¼Œè€Œæ˜¯ä¼šç«‹å³å‘å®¢æˆ·ç«¯è¿”å›ä¸€ä¸ªç‰¹å®šçš„ HTTP çŠ¶æ€ç ï¼ˆå¦‚ 307 Temporary Redirectï¼‰ æˆ–ä¸€ä¸ªåŒ…å«é”™è¯¯ç å’Œä¿¡æ¯çš„JSONå“åº”ã€‚è¿™ä¸ªå“åº”çš„æ ¸å¿ƒå†…å®¹æ˜¯ï¼šâ€œæˆ‘ä¸æ˜¯Leaderï¼Œå½“å‰çš„Leaderåœ°å€æ˜¯ `http://leader-node-ip:8848`â€ã€‚å½“å®¢æˆ·ç«¯æ”¶åˆ°è¿™æ ·çš„é‡å®šå‘å“åº”åï¼Œå®¢æˆ·ç«¯ä¸ä¼šå‘ç”¨æˆ·æŠ›å‡ºé”™è¯¯ï¼Œè€Œæ˜¯è‡ªåŠ¨åœ°ã€é€æ˜åœ°é‡æ–°å‘èµ·è¯·æ±‚ï¼Œè¿™æ¬¡ç›´æ¥è¯·æ±‚Followerå‘Šè¯‰å®ƒçš„é‚£ä¸ªLeaderåœ°å€ã€‚


>  æ³¨æ„ï¼š

> ç”±äºè¿™ç§ç‰¹æ€§ï¼ŒFollowerèŠ‚ç‚¹ç»™å‡ºçš„Leaderåœ°å€æ˜¯å†…ç½‘çš„ï¼Œæ— æ³•è¢«è®¿é—®åˆ°å¤–ç½‘ã€‚æ‰€ä»¥ä¼šå¯¼è‡´é›†ç¾¤æ— æ³•æ­£å¸¸è®¿é—®ã€‚

> Nacosè®¾è®¡æ—¶å·²ç»è€ƒè™‘åˆ°äº†è¿™ç§ç½‘ç»œéš”ç¦»çš„åœºæ™¯ã€‚è§£å†³æ–¹æ¡ˆçš„æ ¸å¿ƒæ˜¯ï¼šè®©æ¯ä¸ªNacosèŠ‚ç‚¹æ˜ç¡®çŸ¥é“â€œå®¢æˆ·ç«¯é€šè¿‡å“ªä¸ªå…¬å…±åœ°å€æ¥è®¿é—®æˆ‘â€ã€‚è¿™æ ·ï¼Œå½“Followeréœ€è¦è¿”å›é‡å®šå‘ä¿¡æ¯æ—¶ï¼Œå®ƒå°±ä¸ä¼šè¿”å›è‡ªå·±çš„å†…ç½‘åœ°å€ï¼Œè€Œæ˜¯è¿”å›è¿™ä¸ªé…ç½®å¥½çš„å…¬å…±åœ°å€ã€‚

éœ€è¦åœ¨æ¯ä¸ªNacosèŠ‚ç‚¹çš„é…ç½®æ–‡ä»¶ä¸­`conf/application.properties`ï¼Œæ·»åŠ æˆ–ä¿®æ”¹ä»¥ä¸‹å‚æ•°ï¼š
```properties
# Nacosçš„IPåœ°å€ï¼ˆå®¢æˆ·ç«¯èƒ½è®¿é—®åˆ°çš„IPï¼Œå³Nginxçš„IPæˆ–åŸŸåï¼‰
nacos.inetutils.ip-address=your.nginx.public.ip
# Nacosçš„ç«¯å£ï¼ˆå®¢æˆ·ç«¯èƒ½è®¿é—®åˆ°çš„ç«¯å£ï¼Œå³Nginxç›‘å¬çš„ç«¯å£ï¼Œé€šå¸¸æ˜¯80/443/8848ï¼‰
nacos.inetutils.port=8848

# å¦ä¸€ä¸ªæ›´ç›´æ¥ã€æ›´æ¨èçš„é…ç½®é¡¹æ˜¯ï¼ˆé«˜ç‰ˆæœ¬Nacosï¼‰ï¼š
# æŒ‡å®šNacosèŠ‚ç‚¹å¯¹å¤–æš´éœ²çš„åœ°å€ï¼Œæ ¼å¼ä¸º ip:port
nacos.member.list=your.nginx.public.ip:8848
```


## Nacosçš„CAPæ¨¡å‹

#### é¦–å…ˆï¼Œéœ€è¦ç†è§£CAPç†è®ºï¼Œå®ƒæŒ‡å‡ºåœ¨ä¸€ä¸ªåˆ†å¸ƒå¼ç³»ç»Ÿä¸­ï¼Œä»¥ä¸‹ä¸‰è€…ä¸å¯å…¼å¾—ï¼š

> - Cï¼ˆConsistencyï¼‰ä¸€è‡´æ€§ï¼šæ‰€æœ‰èŠ‚ç‚¹åœ¨åŒä¸€æ—¶é—´çœ‹åˆ°çš„æ•°æ®æ˜¯å®Œå…¨ç›¸åŒçš„ã€‚
> - Aï¼ˆAvailabilityï¼‰å¯ç”¨æ€§ï¼šæ¯ä¸ªè¯·æ±‚éƒ½èƒ½å¾—åˆ°å“åº”ï¼ˆä¸ä¿è¯æ˜¯æœ€æ–°æ•°æ®ï¼‰ã€‚
> - Pï¼ˆPartition Toleranceï¼‰åˆ†åŒºå®¹é”™æ€§ï¼šç³»ç»Ÿåœ¨ç½‘ç»œåˆ†åŒºæƒ…å†µä¸‹ä»ç„¶èƒ½å¤Ÿæ­£å¸¸å·¥ä½œã€‚

#### ğŸŸ¢ APæ¨¡å¼ï¼ˆå¯ç”¨æ€§ + åˆ†åŒºå®¹é”™æ€§ï¼‰

ç‰¹ç‚¹ï¼š

> âœ… é«˜å¯ç”¨ï¼šæ‰€æœ‰è¯·æ±‚éƒ½èƒ½å¾—åˆ°å“åº”ï¼Œä¸ä¼šå› ä¸ºèŠ‚ç‚¹é—´é€šä¿¡é—®é¢˜è€Œæ‹’ç»æœåŠ¡
> 
> âœ… ä½å»¶è¿Ÿï¼šè¯»å†™æ“ä½œå¾ˆå¿«ï¼Œå› ä¸ºä¸éœ€è¦ç­‰å¾…æ‰€æœ‰èŠ‚ç‚¹åŒæ­¥
> 
> âš ï¸ æœ€ç»ˆä¸€è‡´æ€§ï¼šä¸ä¿è¯å¼ºä¸€è‡´æ€§ï¼Œæ•°æ®åœ¨ä¸åŒèŠ‚ç‚¹é—´å¯èƒ½å­˜åœ¨çŸ­æš‚ä¸ä¸€è‡´ï¼Œä½†æœ€ç»ˆä¼šä¸€è‡´

ç†å¿µã€åœºæ™¯ã€Nacosä½“ç°ï¼š

> - æ ¸å¿ƒç†å¿µï¼šä¿è¯æœåŠ¡æ°¸è¿œå¯ç”¨ï¼Œå³ä½¿è¿™æ„å‘³ç€ä¸åŒèŠ‚ç‚¹å¯èƒ½æš‚æ—¶çœ‹åˆ°ä¸åŒçš„æ•°æ®ã€‚
> - å…¸å‹åº”ç”¨åœºæ™¯ï¼šæœåŠ¡æ³¨å†Œä¸å‘ç°ã€ç¤¾äº¤åª’ä½“çš„ç‚¹èµæ•°ã€è¯„è®ºæ•°ã€ç”µå•†ç½‘ç«™çš„è´­ç‰©è½¦ã€‚
> - åœ¨Nacosä¸­çš„ä½“ç°ï¼šå½“Nacosä»¥APæ¨¡å¼è¿è¡Œæ—¶ï¼ˆé»˜è®¤çš„æœåŠ¡æ³¨å†Œå‘ç°æ¨¡å¼ï¼‰ï¼ŒæœåŠ¡å®ä¾‹å¯ä»¥å‘ä»»æ„èŠ‚ç‚¹æ³¨å†Œï¼ŒèŠ‚ç‚¹é—´å¼‚æ­¥åŒæ­¥æœåŠ¡æ³¨å†Œä¿¡æ¯ï¼Œå³ä½¿éƒ¨åˆ†èŠ‚ç‚¹å®•æœºæˆ–ç½‘ç»œåˆ†åŒºï¼ŒæœåŠ¡å‘ç°åŠŸèƒ½ä»ç„¶å¯ç”¨ã€‚

#### ğŸ”µ CPæ¨¡å¼ï¼ˆä¸€è‡´æ€§ + åˆ†åŒºå®¹é”™æ€§ï¼‰

ç‰¹ç‚¹ï¼š

> âœ… å¼ºä¸€è‡´æ€§ï¼šæ‰€æœ‰èŠ‚ç‚¹çœ‹åˆ°çš„æ•°æ®å®Œå…¨ç›¸åŒ
> 
> âœ… æ•°æ®å®‰å…¨ï¼šä¸ä¼šå‡ºç°æ•°æ®å†²çªæˆ–ä¸¢å¤±
> 
> âš ï¸ å¯èƒ½ç‰ºç‰²å¯ç”¨æ€§ï¼šåœ¨èŠ‚ç‚¹é—´é€šä¿¡å¤±è´¥æ—¶ï¼Œä¸ºäº†ä¿è¯ä¸€è‡´æ€§ï¼Œç³»ç»Ÿå¯èƒ½æ‹’ç»å†™æ“ä½œæˆ–éƒ¨åˆ†è¯»æ“ä½œ

ç†å¿µã€åœºæ™¯ã€Nacosä½“ç°ï¼š

> - æ ¸å¿ƒç†å¿µï¼šä¿è¯æ•°æ®ç»å¯¹ä¸€è‡´ï¼Œå³ä½¿è¿™æ„å‘³ç€åœ¨æŸäº›æƒ…å†µä¸‹æœåŠ¡ä¸å¯ç”¨ã€‚
> - å…¸å‹åº”ç”¨åœºæ™¯ï¼šé“¶è¡Œäº¤æ˜“ç³»ç»Ÿã€é…ç½®ä¿¡æ¯ç®¡ç†ã€åˆ†å¸ƒå¼é”æœåŠ¡ã€‚
> - åœ¨Nacosä¸­çš„ä½“ç°ï¼šå½“Nacosä»¥CPæ¨¡å¼è¿è¡Œæ—¶ï¼ˆé»˜è®¤çš„é…ç½®ç®¡ç†æ¨¡å¼ï¼‰ï¼Œä½¿ç”¨Raftåè®®ä¿è¯é…ç½®æ•°æ®çš„ä¸€è‡´æ€§ï¼Œå†™æ“ä½œå¿…é¡»ç”±LeaderèŠ‚ç‚¹å¤„ç†å¹¶åŒæ­¥åˆ°å¤šæ•°èŠ‚ç‚¹ï¼Œåœ¨ç½‘ç»œåˆ†åŒºæ—¶ï¼Œå°‘æ•°æ´¾åˆ†åŒºå¯èƒ½æ— æ³•æä¾›å†™æœåŠ¡ã€‚

#### æ€»ç»“

> - AP = å®å¯æš‚æ—¶æ•°æ®ä¸ä¸€è‡´ï¼Œä¹Ÿè¦ä¿è¯æœåŠ¡å¯ç”¨
> - CP = å®å¯æš‚æ—¶æœåŠ¡ä¸å¯ç”¨ï¼Œä¹Ÿè¦ä¿è¯æ•°æ®ä¸€è‡´

é€‰æ‹©å»ºè®®ï¼š

> - å¯¹äºæœåŠ¡æ³¨å†Œå‘ç°ï¼Œä¼˜å…ˆé€‰æ‹©APæ¨¡å¼ï¼ˆNacosé»˜è®¤ï¼‰
> - å¯¹äºé…ç½®ç®¡ç†ï¼Œä¼˜å…ˆé€‰æ‹©CPæ¨¡å¼ï¼ˆNacosé»˜è®¤ï¼‰

æ ¹æ®ä¸šåŠ¡åœºæ™¯çš„å®¹å¿åº¦æ¥å†³ç­–ï¼šèƒ½æ¥å—çŸ­æš‚æ•°æ®ä¸ä¸€è‡´é€‰APï¼Œè¦æ±‚æ•°æ®ç»å¯¹å‡†ç¡®é€‰CP

#### åœ¨Nacosä¸­å¯ä»¥é€šè¿‡ä»¥ä¸‹æ–¹å¼æŒ‡å®šæ¨¡å¼ï¼š

```bash
# åˆ›å»ºä½¿ç”¨APæ¨¡å¼çš„å‘½åç©ºé—´ï¼ˆé»˜è®¤ï¼‰
curl -X POST 'http://localhost:8848/nacos/v1/ns/operator/switch?entry=serverMode&value=AP'

# åˆ›å»ºä½¿ç”¨CPæ¨¡å¼çš„å‘½åç©ºé—´
curl -X POST 'http://localhost:8848/nacos/v1/ns/operator/switch?entry=serverMode&value=CP'
```

NacosåŒæ—¶ä¹Ÿæ”¯æŒåœ¨æœåŠ¡æ³¨å†Œæ—¶æŒ‡å®šï¼š

```java
// Spring Cloud Alibaba ç¤ºä¾‹
@SpringBootApplication
public class Application {
    public static void main(String[] args) {
        SpringApplication.run(Application.class, args);
    }
    
    @Bean
    public NamingService namingService() {
        // æŒ‡å®šå‘½åç©ºé—´ï¼Œå¯¹åº”ä¸åŒçš„æ¨¡å¼
        Properties properties = new Properties();
        properties.setProperty("serverAddr", "localhost:8848");
        properties.setProperty("namespace", "æ‚¨åˆ›å»ºçš„å‘½åç©ºé—´ID");
        return NamingFactory.createNamingService(properties);
    }
}
```

## å¦‚ä½•é…ç½®Nacos

åœ¨Spring Cloudé¡¹ç›®é‡Œé…ç½®Nacosï¼Œä¸»è¦æ˜¯åœ¨ `bootstrap.yml` æ–‡ä»¶ä¸­è¿›è¡Œã€‚è¿™æ˜¯å› ä¸ºåº”ç”¨å¯åŠ¨æ—¶éœ€è¦å…ˆè¿æ¥åˆ°Nacosé…ç½®ä¸­å¿ƒæ‹‰å–å¤–éƒ¨é…ç½®ï¼Œè€Œ `bootstrap.yml` çš„åŠ è½½ä¼˜å…ˆçº§é«˜äº `application.yml`ã€‚

ä¸€ä¸ªå®Œæ•´çš„ `bootstrap.yml` é…ç½®æ–‡ä»¶é€šå¸¸å¦‚ä¸‹æ‰€ç¤ºï¼š

```yaml
server:
  port: 8000

spring:
  application:
    name: your-service-name # åŠ¡å¿…è®¾ç½®ï¼Œå®ƒæ˜¯æ„æˆData IDçš„ä¸€éƒ¨åˆ†
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 # Nacosæ³¨å†Œä¸­å¿ƒåœ°å€
      config:
        server-addr: localhost:8848 # Nacosé…ç½®ä¸­å¿ƒåœ°å€
        file-extension: yaml # æŒ‡å®šé…ç½®æ ¼å¼
        namespace: your_namespace_id # å‘½åç©ºé—´IDï¼ˆæ·»åŠ åè‡ªåŠ¨ç”Ÿæˆçš„ä¸€ä¸²uuidï¼‰ï¼Œç”¨äºç¯å¢ƒéš”ç¦»ï¼Œä¸é…ç½®ä¼šè¿ä¸Šé»˜è®¤çš„publicç©ºé—´
        group: YOUR_GROUP_NAME # é…ç½®åˆ†ç»„ï¼Œé»˜è®¤ä¸ºDEFAULT_GROUP
  profiles:
    active: dev # æŒ‡å®šå½“å‰æ¿€æ´»çš„ç¯å¢ƒ
```

Nacosé€šè¿‡ Data ID æ¥æŸ¥æ‰¾å¯¹åº”å‘½åç©ºé—´å’Œåˆ†ç»„ä¸‹çš„é…ç½®ï¼Œå…¶é»˜è®¤ç”Ÿæˆè§„åˆ™æ˜¯ï¼š`${spring.application.name}-${spring.profiles.active}.${file-extension}`

å¹¶ä¸”æˆ‘ä»¬å¯ä»¥é€šè¿‡ `Spring Cloud` åŸç”Ÿæ³¨è§£ `@RefreshScope` å®ç°é…ç½®è‡ªåŠ¨æ›´æ–°

## å®æˆ˜é…ç½®Nacos

é¡¹ç›®`bootstrap.yml` é…ç½®:

```yaml
server:
  port: 80

spring:
  application:
    name: OMS
  cloud:
    nacos:
      discovery:
        server-addr: localhost:8848 # Nacosæ³¨å†Œä¸­å¿ƒåœ°å€
      config:
        server-addr: localhost:8848 # Nacosé…ç½®ä¸­å¿ƒåœ°å€
        file-extension: yaml # æŒ‡å®šé…ç½®æ ¼å¼
        namespace: 16fd2706-8baf-433b-82eb-8c7fada847da # XXé¡¹ç›®çš„å‘½åç©ºé—´ID
        group: OMS_GROUP # OMSåˆ†ç»„ï¼Œä¸WMSã€TMSåˆ†ç»„éš”ç¦»
  profiles:
    active: prod # æŒ‡å®šå½“å‰æ¿€æ´»çš„ç¯å¢ƒ
```

Nacosåœ¨å¯¹åº”å‘½åç©ºé—´å’Œåˆ†ç»„ä¸‹åˆ›å»ºä¸€ä¸ªé…ç½®æ–‡ä»¶ï¼Œæ–‡ä»¶åä¸ºï¼š`OMS-prod.yaml`ï¼Œæ–‡ä»¶å†…å®¹ï¼š

```yaml
your:
  config:
    item: "Nacosé…ç½®ä¸­å¿ƒ"
```

é¡¹ç›®javaä»£ç è¯»å–é…ç½®:

```java
import org.springframework.cloud.context.config.annotation.RefreshScope;

@RestController
@RefreshScope // æ”¯æŒNacosçš„åŠ¨æ€åˆ·æ–°åŠŸèƒ½
public class MyController {

    // ä»Nacosä¸­è·å–é…ç½®é¡¹
    @Value("${your.config.item}")
    private String configItem;
    
    // ... ä½ çš„ä¸šåŠ¡ä»£ç 
}
```

